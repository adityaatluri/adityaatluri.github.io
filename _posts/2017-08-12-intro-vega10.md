---
title: "Intro Vega10"
layout: post
date: 2017-08-12 22:48
image: /assets/images/markdown.jpg
headerImage: false
tag:
- markdown
- components
- extra
category: blog
author: adityaatluri
description: What's new in Vega for Compute?
# jemoji: '<img class="emoji" title=":ramen:" alt=":ramen:" src="https://assets.github.com/images/icons/emoji/unicode/1f35c.png" height="20" width="20" align="absmiddle">'
---

## Introduction:

Vega10 or GFX9 added new and modified existing isa. We discuss about what the changes and new additions are.

#### Especial Elements
- [Packed Math](#Packed-Math-for-FP16/U16)

---

### Packed Math for FP16/U16
GCN architectures before Vega, Fiji and Polaris do support half-precision vector ALU ops. Few of the half-precision supported by fiji are `v_add_f16`, `v_mul_f16` but, they run at the same rate of full-precision instructions. For example, a fp16 mac and a fp32 mac on fiji takes same number of cycles (gives 8TFLOPs). What previous architectures lack is able to operate on the 16-MSB (16 Most Significant Bits) of vGPRs at full rate. With Vega, not only mac operates on MSB, but can also do mac on both LSB and MSB at the same time pushing the available peak throughput to 25TFLOPs. This feature is called Rapid Packed Math, across this text we use the word Packed-Math and Rapid Packed Math interchangably. The new isa also support signed and unsigned shorts. Here are the new 16bit isa ops added to vega:

{% highlight asm %}
v_pk_mad_i16
v_pk_mul_lo_u16
v_pk_add_i16
v_pk_sub_i16
v_pk_lshlrev_b16
v_pk_lshrrev_b16
v_pk_ashrrev_i16
v_pk_max_i16
v_pk_min_i16
v_pk_mad_u16
v_pk_add_u16
v_pk_sub_u16
v_pk_max_u16
v_pk_min_u16

v_pk_fma_f16
v_pk_add_f16
v_pk_mul_f16
v_pk_min_f16
v_pk_max_f16

v_mad_mix_f32
v_mad_mixlo_f16
v_mad_mixhi_f16

s_pack_ll_b16_b32
s_pack_lh_b16_b32
s_pack_hh_b16_b32
{% endhighlight %}

For discussion, we focus on fp16 instructions. Same concepts can be extended to i16 instructions.

These instructions operate on a 32 bit register containing 2 fp16 data. Vega adds more modifiers to these instructions giving flexibility to access MSB and LSB between vgprs instead of simple vectorized op. These isa support `opsel_hi:[0,0,0] opsel:[1,1,1]` modifiers which can grab fp16 from either MSB or LSB of a register.
For example, let us try out a simple 2x2 matrix multiplication where 2 fp16s are packed into one register making up of 2 registers per matrix. For simplicity, we assume that matrix A `{a.x, a.y, a.z, a.w}` is present in `v[1:2]`, B `{b.x, b.y, b.z, b.w}` in `v[3:4]` and C `{c.x, c.y, c.z, c.w}` in `v[5:6]`

The result is,

{% highlight cpp %}
c.x = a.x * b.x + a.y * b.z + c.x;
c.y = a.x * b.y + a.y * b.w + c.y;
c.z = a.z * b.x + a.w * b.z + c.z;
c.w = a.z * b.y + a.w * b.w + c.w;
{% endhighlight %}

The following HIP kernel translates 2x2 fp16 gemm kernel to packed math isa.

{% highlight cpp %}
extern "C" half4 pk_fma_f16(half4, half4, half4) __asm("llvm.fma.v2f16");

__global__ void MatMul(half4 *A, half4 *B, half4 *C) {
  int tx = hipThreadIdx_x;
  half4 a = A[tx];
  half4 b = B[tx];
  half4 c = C[tx];

  c.xy = pk_fma_f16(a.xx, b.xy, c.xy);
  c.xy = pk_fma_f16(a.yy, b.zw, c.xy);

  c.zw = pk_fma_f16(a.zz, b.xy, c.zw);
  c.zw = pk_fma_f16(a.ww, b.zw, c.zw);

  C[tx] = c;
}
{% endhighlight %}

{% highlight shell %}
$ hipcc --amdgpu-target=gfx900 t1.cpp
{% endhighlight %}

This kernel translates to

{% highlight asm %}
v_pk_fma_f16 v5, v1, v3, v5 op_sel:[1,0,0] op_sel_hi:[1,1,1]
v_pk_fma_f16 v5, v1, v4, v5 op_sel:[0,0,0] op_sel_hi:[0,1,1]
v_pk_fma_f16 v6, v2, v3, v5 op_sel:[1,0,0] op_sel_hi:[1,1,1]
v_pk_fma_f16 v6, v2, v4, v5 op_sel:[0,0,0] op_sel_hi:[0,1,1]
{% endhighlight %}


For first 2 instructions, `opsel_hi` and `opsel` control 16bits of destination register. For first instruction, `1,1,1` in `opsel_hi` represent `v1[16:31], v3[16:31], v5[16:31]` and `1,0,0` in `opsel` represent `v1[16:31], v3[0:15], v5[0:15]`. For second instruction, `0,1,1` in `opsel_hi` represent `v1[0:15], v4[16:31], v5[16:31]` and `0,0,0` represent `v1[0:15], v4[0:15], v5[0:15]`.
A peak of 25TFLOPs can be achieved with these instructions on MI25.
ROCm stack uses clang/llvm as front end compiler to generate isa for vega. To check the correctness and whether the compiler can generate vega binaries, you can use the following command:

{% highlight shell %}
$ echo “v_pk_fma_f16 v5, v1, v3, v5 op_sel:[1,0,0] op_sel_hi:[1,1,1]” | llvm-mc -show-encoding -arch=amdgcn -mcpu=gfx900
 .text
 v_pk_fma_f16 v5, v1, v3, v5 op_sel:[1,0,0] ; encoding: [0x05,0x48,0x8e,0xd3,0x01,0x07,0x16,0x1c]
{% endhighlight %}

---

## Side-by-side

Like the [Medium](https://medium.com/) component.

**Image** on the left and **Text** on the right:

{% highlight html %}
<div class="side-by-side">
    <div class="toleft">
        <img class="image" src="{{ site.url }}/{{ site.picture }}" alt="Alt Text">
        <figcaption class="caption">Photo by John Doe</figcaption>
    </div>

    <div class="toright">
        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
    </div>
</div>
{% endhighlight %}

<div class="side-by-side">
    <div class="toleft">
        <img class="image" src="{{ site.url }}/{{ site.picture }}" alt="Alt Text">
        <figcaption class="caption">Photo by John Doe</figcaption>
    </div>

    <div class="toright">
        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
    </div>
</div>

**Text** on the left and **Image** on the right:

{% highlight html %}
<div class="side-by-side">
    <div class="toleft">
        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
    </div>

    <div class="toright">
        <img class="image" src="{{ site.url }}/{{ site.picture }}" alt="Alt Text">
        <figcaption class="caption">Photo by John Doe</figcaption>
    </div>
</div>
{% endhighlight %}

<div class="side-by-side">
    <div class="toleft">
        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
    </div>

    <div class="toright">
        <img class="image" src="{{ site.url }}/{{ site.picture }}" alt="Alt Text">
        <figcaption class="caption">Photo by John Doe</figcaption>
    </div>
</div>

---

## Star

You can give evidence to a post. Just add the tag to the markdown file.

{% highlight raw %}
star: true
{% endhighlight %}

---

## Especial Breaker

You can add a especial *hr* to your text.

{% highlight html %}
<div class="breaker"></div>
{% endhighlight %}

<div class="breaker"></div>

---

## Spoiler

You can add an especial hidden content that appears on hover.

{% highlight html %}
<div class="spoiler"><p>your content</p></div>
{% endhighlight %}

<div class="spoiler"><p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p></div>

---

## Gist

You can add Gists from github.

{% highlight raw %}
{ % gist sergiokopplin/91ff4220480727b47224245ee2e9c291 % }
{% endhighlight %}

{% gist sergiokopplin/91ff4220480727b47224245ee2e9c291 %}

---

## Codepen

You can add Pens from Codepen.

{% highlight html %}
<p data-height="268" data-theme-id="0" data-slug-hash="gfdDu" data-default-tab="result" data-user="chriscoyier" class='codepen'>
    See the Pen <a href='http://codepen.io/chriscoyier/pen/gfdDu/'>Crappy Recreation of the Book Cover of *The Flame Alphabet*</a> by Chris Coyier (<a href='http://codepen.io/chriscoyier'>@chriscoyier</a>) on <a href='http://codepen.io'>CodePen</a>.
</p>
<script async src="//assets.codepen.io/assets/embed/ei.js"></script>
{% endhighlight %}

<p data-height="268" data-theme-id="0" data-slug-hash="gfdDu" data-default-tab="result" data-user="chriscoyier" class='codepen'>See the Pen <a href='http://codepen.io/chriscoyier/pen/gfdDu/'>Crappy Recreation of the Book Cover of *The Flame Alphabet*</a> by Chris Coyier (<a href='http://codepen.io/chriscoyier'>@chriscoyier</a>) on <a href='http://codepen.io'>CodePen</a>.</p>
<script async src="//assets.codepen.io/assets/embed/ei.js"></script>

---

## Slideshare

Add your presentations here!

{% highlight html %}
<iframe src="//www.slideshare.net/slideshow/embed_code/key/hqDhSJoWkrHe7l" width="560" height="310" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe>
{% endhighlight %}

<iframe src="//www.slideshare.net/slideshow/embed_code/key/hqDhSJoWkrHe7l" width="560" height="310" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe>

---

## Videos

Do you want some videos? Youtube, Vimeo or Vevo? Copy the embed code and paste on your post!

**Example**

{% highlight html %}
<iframe width="560" height="310" src="https://www.youtube.com/embed/r7XhWUDj-Ts" frameborder="0" allowfullscreen></iframe>
{% endhighlight %}

<iframe width="560" height="310" src="https://www.youtube.com/embed/r7XhWUDj-Ts" frameborder="0" allowfullscreen></iframe>

[1]: http://daringfireball.net/projects/markdown/
[2]: http://www.fileformat.info/info/unicode/char/2163/index.htm
[3]: http://www.markitdown.net/
[4]: http://daringfireball.net/projects/markdown/basics
[5]: http://daringfireball.net/projects/markdown/syntax
[6]: http://kune.fr/wp-content/uploads/2013/10/ghost-blog.jpg
